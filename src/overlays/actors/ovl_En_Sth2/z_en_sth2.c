/*
 * File: z_en_sth2.c
 * Overlay: ovl_En_Sth2
 * Description: Guy waving at the telescope in Termina Field
 */

#include "z_en_sth2.h"

#define FLAGS (ACTOR_FLAG_1 | ACTOR_FLAG_8)

#define THIS ((EnSth2*)thisx)

void EnSth2_Init(Actor* thisx, PlayState* play);
void EnSth2_Destroy(Actor* thisx, PlayState* play);
void EnSth2_Update(Actor* thisx, PlayState* play);

void func_80BF75A0(EnSth2* this, PlayState* play);
void func_80BF7688(EnSth2* this, PlayState* play);
void func_80BF7814(EnSth2* this, PlayState* play2);
s32 func_80BF76AC(PlayState* play, s32 limbIndex, Gfx** dList, Vec3f* pos, Vec3s* rot, Actor* thisx); /* extern */
void func_80BF77AC(PlayState* play, s32 limbIndex, Gfx** dList, Vec3s* rot, Actor* thisx);            /* extern */

#if 0
const ActorInit En_Sth2_InitVars = {
    ACTOR_EN_STH2,
    ACTORCAT_NPC,
    FLAGS,
    GAMEPLAY_KEEP,
    sizeof(EnSth2),
    (ActorFunc)EnSth2_Init,
    (ActorFunc)EnSth2_Destroy,
    (ActorFunc)EnSth2_Update,
    (ActorFunc)NULL,
};

static s16 D_80BF99F8[0x2D4] = {
    0,       0x8FF,   0xC000,  0x8FF,   0x9DD,   0xB7C,   0xC62,   0xB95,   0xA10,   0x94C,   0x9E6,   0xB1E,   0xC60,
    0xD1C,   0xD53,   0xD6D,   0xD6E,   0xD5C,   0xD3A,   0xD0C,   0xCD7,   0xCA0,   0xC5C,   0xC05,   0xB9E,   0xB2F,
    0xABC,   0xA4B,   0x9E3,   0x988,   0x93F,   0x910,   0x8FF,   0,       0x2F,    0x87,    0xB7,    0x87,    0x2F,
    0,       0x1D,    0x5B,    0x9A,    0xB7,    0xB0,    0x9E,    0x84,    0x65,    0x45,    0x27,    0xF,     0,
    -8,      -0xD,    -0xF,    -0x10,   -0xE,    -0xC,    -9,      -6,      -3,      -1,      0,       0xC81,   0x506,
    -0x704,  -0xCF8,  -0x7AC,  0x374,   0x9DD,   0x4CE,   -0x462,  -0xCD1,  -0x11C0, -0x1364, -0x1442, -0x1439, -0x1374,
    -0x1245, -0x10E2, -0xF6B,  -0xDF6,  -0xC3F,  -0xA0A,  -0x76F,  -0x483,  -0x161,  0x1DA,   0x504,   0x7E9,   0xA4C,
    0xBEA,   0xC81,   -0x22D5, -0x21E4, -0x1E4E, -0x1B1C, -0x1E00, -0x218B, -0x2285, -0x21C6, -0x1F4D, -0x1B28, -0x1754,
    -0x15AD, -0x14B0, -0x14AD, -0x1576, -0x169A, -0x17D1, -0x18FA, -0x1A08, -0x1B28, -0x1C6F, -0x1DBB, -0x1EF3, -0x2009,
    -0x20F3, -0x21AC, -0x2235, -0x2290, -0x22C4, -0x22D5, -0x3397, -0x2A06, -0x199E, -0x107E, -0x18BF, -0x2831, -0x309B,
    -0x2A29, -0x1DCD, -0x1129, -0x8A4,  -0x5A4,  -0x425,  -0x48C,  -0x681,  -0x935,  -0xC23,  -0xF02,  -0x11A2, -0x1472,
    -0x17D4, -0x1B90, -0x1F81, -0x2384, -0x2777, -0x2B30, -0x2E7F, -0x312A, -0x32F2, -0x3397, 0x471F,  0x4037,  0x303A,
    0x2450,  0x2F13,  0x3E80,  0x44D4,  0x3FED,  0x345D,  0x248D,  0x16E4,  0x110F,  0xD94,   0xD8D,   0x1062,  0x147C,
    0x18DD,  0x1D16,  0x20EF,  0x2515,  0x29DF,  0x2EDA,  0x33BB,  0x3850,  0x3C74,  0x400B,  0x42FE,  0x4536,  0x469F,
    0x471F,  -0x1641, -0x1542, -0x135C, -0x122E, -0x12AE, -0x13E7, -0x14A0, -0x141D, -0x131A, -0x1297, -0x12AE, -0x12CE,
    -0x12F7, -0x1327, -0x135C, -0x1397, -0x13D5, -0x1415, -0x1457, -0x1499, -0x14DB, -0x151A, -0x1556, -0x158D, -0x15C0,
    -0x15EB, -0x160F, -0x162A, -0x163B, -0x1641, -0x2C3,  -0x4E0,  -0x797,  -0x89F,  -0x7B2,  -0x53E,  -0x37F,  -0x4DE,
    -0x6FD,  -0x884,  -0x929,  -0x948,  -0x94C,  -0x93A,  -0x91A,  -0x8EE,  -0x8BA,  -0x883,  -0x84C,  -0x80B,  -0x7B3,
    -0x743,  -0x6BC,  -0x61F,  -0x56F,  -0x4B5,  -0x3FF,  -0x35F,  -0x2EE,  -0x2C3,  0xB14B,  0xB21B,  0xB631,  0xBA68,
    0xB6A1,  0xB293,  0xB1BB,  0xB275,  0xB53A,  0xBA9F,  -0x3FBD, -0x3D01, -0x3B33, -0x3AEC, -0x3BED, -0x3D78, -0x3F1D,
    0xBF4F,  0xBDD8,  0xBC3B,  0xBA63,  0xB88A,  0xB6D0,  0xB549,  0xB401,  0xB2FC,  0xB239,  0xB1B3,  0xB165,  0xB14B,
    -0xC8C,  -0x50E,  0x701,   0xCF6,   0x7A9,   -0x37B,  -0x9E6,  -0x4D5,  0x45E,   0xCCF,   0x11C0,  0x1366,  0x1443,
    0x143B,  0x1375,  0x1245,  0x10E2,  0xF6B,   0xDF5,   0xC3D,   0xA07,   0x76B,   0x47F,   0x15C,   -0x1E0,  -0x50B,
    -0x7F2,  -0xA55,  -0xBF4,  -0xC8C,  0x22D8,  0x21E7,  0x1E52,  0x1B1F,  0x1E04,  0x218F,  0x2288,  0x21C9,  0x1F51,
    0x1B2B,  0x1756,  0x15AE,  0x14B2,  0x14AE,  0x1578,  0x169D,  0x17D4,  0x18FD,  0x1A0B,  0x1B2B,  0x1C73,  0x1DBE,
    0x1EF7,  0x200D,  0x20F6,  0x21B0,  0x2238,  0x2293,  0x22C7,  0x22D8,  -0x33A2, -0x2A0D, -0x19A0, -0x107E, -0x18C2,
    -0x2838, -0x30A5, -0x2A31, -0x1DD0, -0x112A, -0x8A2,  -0x5A2,  -0x422,  -0x489,  -0x67F,  -0x934,  -0xC22,  -0xF02,
    -0x11A2, -0x1474, -0x17D6, -0x1B94, -0x1F85, -0x2389, -0x277D, -0x2B38, -0x2E88, -0x3134, -0x32FC, -0x33A2, 0x4721,
    0x4039,  0x303B,  0x2450,  0x2F13,  0x3E82,  0x44D7,  0x3FEF,  0x345E,  0x248D,  0x16E2,  0x110B,  0xD8E,   0xD87,
    0x105E,  0x1479,  0x18DB,  0x1D14,  0x20EF,  0x2515,  0x29DF,  0x2EDB,  0x33BD,  0x3852,  0x3C76,  0x400D,  0x4300,
    0x4539,  0x46A2,  0x4721,  0x1525,  0x1449,  0x12B3,  0x11E3,  0x12DA,  0x1496,  0x158D,  0x14BE,  0x1329,  0x124B,
    0x124C,  0x1258,  0x126D,  0x128B,  0x12B0,  0x12DB,  0x130B,  0x133F,  0x1375,  0x13AD,  0x13E4,  0x141B,  0x1450,
    0x1482,  0x14AF,  0x14D6,  0x14F7,  0x1510,  0x1520,  0x1525,  0x133,   0x349,   0x5F3,   0x6F4,   0x60D,   0x3A4,
    0x1EB,   0x345,   0x55A,   0x6D7,   0x777,   0x794,   0x795,   0x782,   0x760,   0x733,   0x6FF,   0x6C8,   0x692,
    0x653,   0x5FD,   0x591,   0x50E,   0x476,   0x3CC,   0x318,   0x266,   0x1CB,   0x15D,   0x133,   0xAFF7,  0xB0CE,
    0xB4F3,  0xB933,  0xB565,  0xB14A,  0xB06C,  0xB12C,  0xB3FC,  0xB96E,  0xBF1A,  -0x3E26, -0x3C54, -0x3C0A, -0x3D09,
    -0x3E93, 0xBFC8,  0xBE34,  0xBCBB,  0xBB1B,  0xB940,  0xB761,  0xB5A1,  0xB413,  0xB2C4,  0xB1B8,  0xB0EE,  0xB064,
    0xB012,  0xAFF7,  0x85B4,  0x82A4,  0x7CF4,  0x79E3,  0x7CE3,  0x8283,  0x85B4,  0x858E,  0x84AE,  0x834F,  0x81AC,
    0x8000,  0x7E86,  0x7D78,  0x7D11,  0x7D2D,  0x7D7C,  0x7DF7,  0x7E94,  0x7F4E,  0x801B,  0x80F4,  0x81D1,  0x82AA,
    0x8377,  0x8430,  0x84CE,  0x8549,  0x8598,  0x85B4,  0,       0,       0x8000,  0x8000,  0x8000,  0,       0,
    0,       0,       0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,
    0x8000,  0,       0,       0,       0,       0,       0,       0,       0,       0,       -0x1B55, -0x2ECF, -0x2CDF,
    -0x18E3, -0x2B28, -0x323E, -0x1FDF, -0x2834, -0x3B2F, -0x2E65, -0x1BBC, -0x140B, -0x14F0, -0x171F, -0x1A6D, -0x1EB2,
    -0x23C4, -0x2979, -0x2FA8, -0x3627, -0x3CCD, -0x3C90, -0x3619, -0x2FF8, -0x2A57, -0x255F, -0x2139, -0x1E0F, -0x1C0A,
    -0x1B55, 0x8000,  0x8000,  0,       0,       0,       0x8000,  0x8000,  0x8000,  0x8000,  0,       0,       0,
    0,       0,       0,       0,       0,       0,       0,       0,       0,       0x8000,  0x8000,  0x8000,  0x8000,
    0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0,       0,       0x8000,  0x8000,  0x8000,  0,       0,       0,
    0,       0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,  0x8000,
    0,       0,       0,       0,       0,       0,       0,       0,       0,       0x1B55,  0x2ECF,  0x2CDF,  0x18E3,
    0x2B28,  0x323E,  0x1FDF,  0x2834,  0x3B2F,  0x2E65,  0x1BBC,  0x140B,  0x14F0,  0x171F,  0x1A6D,  0x1EB2,  0x23C4,
    0x2979,  0x2FA8,  0x3627,  0x3CCD,  0x3C90,  0x3619,  0x2FF8,  0x2A57,  0x255F,  0x2139,  0x1E0F,  0x1C0A,  0x1B55,
    0x8000,  0x8000,  0,       0,       0,       0x8000,  0x8000,  0x8000,  0x8000,  0,       0,       0,       0,
    0,       0,       0,       0,       0,       0,       0,       0,       0x8000,  0x8000,  0x8000,  0x8000,  0x8000,
    0x8000,  0x8000,  0x8000,  0x8000,  0,       0x289,   0x73E,   0x9C7,   0x89B,   0x5D5,   0x297,   0,       -0x1FF,
    -0x41C,  -0x62E,  -0x80F,  -0x997,  -0xA9F,  -0xB00,  -0xADC,  -0xA77,  -0x9DB,  -0x912,  -0x826,  -0x721,  -0x60D,
    -0x4F3,  -0x3DF,  -0x2DA,  -0x1EE,  -0x125,  -0x89,   -0x24,   0,       0,
};
static JointIndex D_80BF9FA0[0x10] = {
    { 0, 3, 0x21 },
    { 2, 0, 2 },
    { 0x3F, 0x5D, 0x7B },
    { 0, 0, 0x99 },
    { 0xB7, 0xD5, 0xF3 },
    { 0x111, 0x12F, 0x14D },
    { 0, 0, 0x16B },
    { 0x189, 0x1A7, 0x1C5 },
    { 0, 0, 0x1E3 },
    { 0x201, 0x21F, 0x23D },
    { 0, 0, 0 },
    { 0, 0, 0 },
    { 0x25B, 0x279, 0x297 },
    { 0, 0, 0 },
    { 0, 0, 0 },
    { 0, 0, 0x2B5 },
};
static AnimationHeader D_80BFA000 = { { 0x1E }, D_80BF99F8, D_80BF9FA0, 3 };
Color_RGB8 D_80BFA01C[] = { { 189, 110, 0 },  { 0, 180, 110 },   { 0, 255, 80 },
                            { 255, 160, 60 }, { 189, 230, 250 }, { 240, 230, 120 } };
#endif

extern UNK_TYPE D_060031F8;
extern AnimationHeader D_80BFA000;
extern Gfx D_80BF9550;
extern Gfx D_80BF9870;
extern Vec3f D_80BFA010;
extern Color_RGB8 D_80BFA01C[];

void EnSth2_Init(Actor* thisx, PlayState* play) {
    EnSth2* this = THIS;
    
    this->unk24A = Object_GetIndex(&play->objectCtx, 0x26A);
    Actor_SetScale(&this->actor, 0.01f);
    ActorShape_Init(&this->actor.shape, 0.0f, ActorShadow_DrawCircle, 36.0f);
    this->unk248 = 0;

    if ((play->actorCtx.unk5 & 2) != 0) {
        this->actor.flags |= 0x30;
    } else {
        Actor_MarkForDeath(&this->actor);
        return;
    }
    this->actionFunc = func_80BF75A0;
}

void EnSth2_Destroy(Actor* thisx, PlayState* play) {
}

void func_80BF75A0(EnSth2* this, PlayState* play) {
    SkelAnime_Update(&this->unk144);
}

void EnSth2_Update(Actor* thisx, PlayState* play) {
    s32 pad;
    EnSth2* this = (EnSth2*)thisx;

    if (Object_IsLoaded(&play->objectCtx, (s32)(u8)this->unk24A) != 0) {
        this->actor.objBankIndex = (s8)(u8)this->unk24A;
        Actor_SetObjectDependency(play, &this->actor);
        SkelAnime_InitFlex(play, &this->unk144, (FlexSkeletonHeader*)&D_060031F8, &D_80BFA000, &this->unk188,
                           &this->unk1E8, 0x10);
        Animation_PlayLoop(&this->unk144, &D_80BFA000);
        this->actor.update = func_80BF7688;
        this->actor.draw = func_80BF7814;
    }
}

void func_80BF7688(EnSth2* this, PlayState* play) {
    this->actionFunc(this, play);
}

s32 func_80BF76AC(PlayState *play, s32 limbIndex, Gfx **dList, Vec3f *pos, Vec3s *rot, Actor *thisx) {
    s32 pad;

    if (limbIndex == 15) {
        *dList = &D_80BF9550;
    }
    if ((limbIndex == 8) || (limbIndex == 10) || (limbIndex == 13)) {
        rot->y += (s16) (Math_SinS((play->state.frames * ((limbIndex * 0x32) + 0x814))) * 200.0f);
        rot->z += (s16) (Math_CosS((play->state.frames * ((limbIndex * 0x32) + 0x940))) * 200.0f);
    }
    return false;
}

void func_80BF77AC(PlayState* play, s32 limbIndex, Gfx** dList, Vec3s* rot, Actor* thisx) {
    if (limbIndex == 15) {
        Matrix_MultVec3f(&D_80BFA010, &thisx->focus.pos);
        OPEN_DISPS(play->state.gfxCtx);
        gSPDisplayList(POLY_OPA_DISP++, &D_80BF9870);
        CLOSE_DISPS(play->state.gfxCtx);
    }
}

void func_80BF7814(EnSth2* this, PlayState* play2) {
    PlayState* play = play2;
    s32 pad;
    
    OPEN_DISPS(play->state.gfxCtx);

    func_8012C28C(play->state.gfxCtx);
    gSPSegment(
        POLY_OPA_DISP++, 0x08,
        Gfx_EnvColor(play->state.gfxCtx, (s32)D_80BFA01C[1].r, (s32)D_80BFA01C[1].g, (s32)D_80BFA01C[1].b, 0xFF));
    gSPSegment(POLY_OPA_DISP++, 0x09, Gfx_EnvColor(play->state.gfxCtx, 90, 110, 130, 255));
    SkelAnime_DrawFlexOpa(play, this->unk144.skeleton, this->unk144.jointTable, (s32)this->unk144.dListCount,
                          func_80BF76AC, func_80BF77AC, &this->actor);

    CLOSE_DISPS(play->state.gfxCtx);
}
